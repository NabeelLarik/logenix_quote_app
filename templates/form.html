<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Logenix Quote Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { background: #f5f6fa; }
        .form-card { width: 100%; max-width: 1600px; margin: auto; border-radius: 12px; }
        .card { border: none; border-radius: 14px; }
        .form-label { font-weight: 600; }

        .section-title{
            font-weight: 800;
            color: #0d6efd;
            margin: 6px 0 10px 0;
        }
        .subtle-note{
            font-size: 12px;
            color: #6c757d;
            margin-top: 6px;
        }

        .box {
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 12px 14px;
            background: #ffffff;
            height: 100%;
        }
        .box-title { font-weight: 700; margin-bottom: 8px; }

        /* Quotes cards */
        .rate-card {
            border-radius: 12px;
            border: 1px solid #dee2e6;
            background: #ffffff;
        }
        .rate-card.best {
            border: 2px solid #198754;
            box-shadow: 0 0 0 0.15rem rgba(25, 135, 84, .15);
        }
        .rate-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 800;
            color: #0d6efd;
        }
        .badge-best {
            background: #198754;
            color: white;
            font-weight: 700;
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 12px;
        }
        .badge-valid {
            background: #d1e7dd;
            color: #0f5132;
            font-weight: 700;
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 12px;
        }
        .badge-expired {
            background: #f8d7da;
            color: #842029;
            font-weight: 700;
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 12px;
        }
        .badge-unknown {
            background: #e2e3e5;
            color: #41464b;
            font-weight: 700;
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 12px;
        }

        .kv {
            margin-top: 12px;
            font-size: 14px;
            font-weight: 400;
        }
        .kv .rowline {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            padding: 6px 0;
            border-bottom: 1px dashed #e9ecef;
        }
        .kv .key { font-weight: 600; color: #212529; flex: 1; }
        .kv .val { font-weight: 400; color: #212529; flex: 1; text-align: right; word-break: break-word; }
        .na { color: #dc3545; font-weight: 800; }

        .gt-row {
            margin-top: 12px;
            padding: 14px 12px !important;
            border-radius: 12px;
            border: 2px solid #0d6efd;
            background: #e7f1ff;
        }
        .gt-row .key {
            color: #0d6efd !important;
            font-weight: 900 !important;
            font-size: 18px !important;
        }
        .gt-row .val {
            color: #0d6efd !important;
            font-weight: 900 !important;
            font-size: 22px !important;
        }

        /* Route chooser */
        .route-select-card{
            border-radius: 12px;
            border: 1px solid #dee2e6;
            background: #ffffff;
            padding: 12px 14px;
        }
        .route-select-title{
            font-weight: 900;
            color: #0d6efd;
            margin-bottom: 8px;
        }
        .route-choice{
            border: 1px dashed #dee2e6;
            border-radius: 12px;
            padding: 10px 12px;
            margin-top: 10px;
            background: #fff;
        }
        .route-choice.best{
            border: 2px solid #0d6efd;
            background: #f3f8ff;
        }
        .route-choice .route-name{ font-weight: 900; }
        .route-choice .route-desc{ margin-top: 6px; }

        .badge-best-route {
            background: #0d6efd;
            color: white;
            font-weight: 800;
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 12px;
        }

        .badge-open {
            background: #d1e7dd;
            color: #0f5132;
            font-weight: 800;
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 12px;
            text-transform: uppercase;
        }
        .badge-closed {
            background: #f8d7da;
            color: #842029;
            font-weight: 800;
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 12px;
            text-transform: uppercase;
        }
        .badge-tt {
            background: #e7f1ff;
            color: #0d6efd;
            font-weight: 800;
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 12px;
        }

        /* Small + buttons */
        .btn-plus {
            width: 30px;
            height: 30px;
            padding: 0;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
        }

        /* Make form feel “wide” */
        .container-fluid { padding-left: 18px; padding-right: 18px; }
    </style>
</head>

<body class="py-4">
<div class="container-fluid">
    <div class="card shadow p-4 form-card">

        <h3 class="mb-3 fw-bold text-primary">Logenix — Quote Input</h3>

        <datalist id="locations">
            {% for c in countries %}
            <option value="{{ c }}">
            {% endfor %}
        </datalist>

        <datalist id="container_types">
            {% for ct in container_types %}
            <option value="{{ ct }}">
            {% endfor %}
        </datalist>

        <datalist id="container_sizes">
            {% for cs in container_sizes %}
            <option value="{{ cs }}">
            {% endfor %}
        </datalist>

        <datalist id="commodities">
            {% for m in commodities %}
            <option value="{{ m }}">
            {% endfor %}
        </datalist>

        <datalist id="salespersons">
            {% for s in salespersons %}
            <option value="{{ s }}">
            {% endfor %}
        </datalist>

        <datalist id="cargo_types">
            {% for ct in cargo_types %}
            <option value="{{ ct }}">
            {% endfor %}
        </datalist>

        <datalist id="packaging_types">
            {% for p in packaging_types %}
            <option value="{{ p }}">
            {% endfor %}
        </datalist>

        <datalist id="insurance_rates">
            <option value="1%"><option value="1.5%"><option value="2%"><option value="2.5%">
            <option value="3%"><option value="3.5%"><option value="4%"><option value="none">
        </datalist>

        <datalist id="misc_costs">
            <option value="50$"><option value="100$"><option value="150$"><option value="200$"><option value="250$">
            <option value="300$"><option value="350$"><option value="400$"><option value="450$"><option value="500$">
        </datalist>

        <form method="post" action="/submit" autocomplete="off" id="quoteForm">
            {% if stage == "routes" %}
                <input type="hidden" name="_action" value="generate">
            {% else %}
                <input type="hidden" name="_action" value="next">
            {% endif %}

            {% if stage != "routes" %}
            <!-- =========================
                 INPUT STAGE (FULL FORM)
                 ========================= -->
            <div class="row g-3">
                <div class="col-lg-6">
                    <label class="form-label">Company Name</label>
                    <input name="company_name" required class="form-control"
                           value="{{ form_data.company_name if form_data and form_data.company_name else '' }}">
                </div>

                <div class="col-lg-6">
                    <label class="form-label">Salesperson Name</label>
                    <input name="salesperson_name" class="form-control" list="salespersons" required
                           placeholder="Select or type salesperson name"
                           value="{{ form_data.salesperson_name if form_data and form_data.salesperson_name else '' }}">
                </div>

                <!-- Container Ownership -->
                <div class="col-lg-6">
                    <div class="box">
                        <div class="box-title">Container Ownership</div>

                        {% set own = form_data.container_ownership if form_data and form_data.container_ownership else "" %}

                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="container_ownership" id="own_soc_cust"
                                   value="SOC - Customer Owned"
                                   {% if own == "SOC - Customer Owned" %}checked{% endif %} required>
                            <label class="form-check-label" for="own_soc_cust">SOC - Customer Owned</label>
                        </div>

                        <div class="form-check mt-1">
                            <input class="form-check-input" type="radio" name="container_ownership" id="own_soc_log"
                                   value="SOC - Logenix Owned"
                                   {% if own == "SOC - Logenix Owned" %}checked{% endif %} required>
                            <label class="form-check-label" for="own_soc_log">SOC - Logenix Owned</label>
                        </div>

                        <div class="form-check mt-1">
                            <input class="form-check-input" type="radio" name="container_ownership" id="own_coc"
                                   value="COC"
                                   {% if own == "COC" %}checked{% endif %} required>
                            <label class="form-check-label" for="own_coc">COC</label>
                        </div>
                    </div>
                </div>

                <!-- Incoterm for Origin -->
                <div class="col-lg-6">
                    <div class="box">
                        <div class="box-title">Incoterm for Origin</div>

                        <div class="row">
                            <div class="col-md-6">
                                {% set inc_origin = form_data.incoterm_origin if form_data and form_data.incoterm_origin else "" %}
                                {% for v in ["EXW – Ex Works","FCA – Free Carrier","CPT – Carriage Paid To","CIP – Carriage and Insurance Paid To","FOR – Free on Rail","DAP – Delivered at Place","DPU – Delivered at Place Unloaded"] %}
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="incoterm_origin" id="inc_origin_{{ loop.index0 }}a" value="{{ v }}"
                                           {% if inc_origin == v %}checked{% endif %} required>
                                    <label class="form-check-label" for="inc_origin_{{ loop.index0 }}a">{{ v }}</label>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="col-md-6">
                                {% for v in ["DDP – Delivered Duty Paid","FOT – Free on Truck","FAS – Free Alongside Ship","FOB – Free on Board","CFR – Cost and Freight","CIF – Cost, Insurance and Freight"] %}
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="incoterm_origin" id="inc_origin_{{ loop.index0 }}b" value="{{ v }}"
                                           {% if inc_origin == v %}checked{% endif %} required>
                                    <label class="form-check-label" for="inc_origin_{{ loop.index0 }}b">{{ v }}</label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Incoterm for Destination -->
                <div class="col-lg-6">
                    <div class="box">
                        <div class="box-title">Incoterm for Destination</div>

                        <div class="row">
                            <div class="col-md-6">
                                {% set inc_dest = form_data.incoterm_destination if form_data and form_data.incoterm_destination else "" %}
                                {% for v in ["EXW – Ex Works","FCA – Free Carrier","CPT – Carriage Paid To","CIP – Carriage and Insurance Paid To","FOR – Free on Rail","DAP – Delivered at Place","DPU – Delivered at Place Unloaded"] %}
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="incoterm_destination" id="inc_dest_{{ loop.index0 }}a" value="{{ v }}"
                                           {% if inc_dest == v %}checked{% endif %} required>
                                    <label class="form-check-label" for="inc_dest_{{ loop.index0 }}a">{{ v }}</label>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="col-md-6">
                                {% for v in ["DDP – Delivered Duty Paid","FOT – Free on Truck","FAS – Free Alongside Ship","FOB – Free on Board","CFR – Cost and Freight","CIF – Cost, Insurance and Freight"] %}
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="incoterm_destination" id="inc_dest_{{ loop.index0 }}b" value="{{ v }}"
                                           {% if inc_dest == v %}checked{% endif %} required>
                                    <label class="form-check-label" for="inc_dest_{{ loop.index0 }}b">{{ v }}</label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- POL / POD -->
              <!-- Pick Up / Delivery Point Details -->
<div class="col-lg-6">
    <div class="d-flex justify-content-between align-items-center">
        <label class="form-label mb-0">Pick Up Point Details</label>
        <button type="button" class="btn btn-outline-primary btn-plus" id="addPolBtn">+</button>
    </div>

    <div id="polContainer" class="mt-2">
        {% for i in range(1,5) %}
        <div class="mt-2 pol-row" data-index="{{ i }}" {% if i>1 and (not form_data or not form_data["shipping_from_" ~ i ~ "_city"]) %}style="display:none;"{% endif %}>
            <div class="box">
                <div class="box-title">Pick Up Point {{ i }}</div>

                <label class="form-label">Factory / Warehouse address</label>
                <input name="shipping_from_{{ i }}_address" class="form-control"
                       placeholder="Type factory/warehouse address..."
                       value="{{ form_data["shipping_from_" ~ i ~ "_address"] if form_data and form_data["shipping_from_" ~ i ~ "_address"] else '' }}">

                <label class="form-label mt-2">Port of Loading</label>
                <input name="shipping_from_{{ i }}_port" class="form-control" list="locations"
                       placeholder="Start typing port of loading..."
                       value="{{ form_data["shipping_from_" ~ i ~ "_port"] if form_data and form_data["shipping_from_" ~ i ~ "_port"] else '' }}">

                <label class="form-label mt-2">City</label>
                <input name="shipping_from_{{ i }}_city" class="form-control" list="locations"
                       {% if i==1 %}required{% endif %}
                       placeholder="Start typing city..."
                       value="{{ form_data["shipping_from_" ~ i ~ "_city"] if form_data and form_data["shipping_from_" ~ i ~ "_city"] else '' }}">

                <label class="form-label mt-2">Country</label>
                <input name="shipping_from_{{ i }}_country" class="form-control" list="locations"
                       placeholder="Start typing country..."
                       value="{{ form_data["shipping_from_" ~ i ~ "_country"] if form_data and form_data["shipping_from_" ~ i ~ "_country"] else '' }}">
            </div>
        </div>
        {% endfor %}
        <div class="subtle-note">You can add up to 3 more Pick Up Points.</div>
    </div>
</div>

<div class="col-lg-6">
    <div class="d-flex justify-content-between align-items-center">
        <label class="form-label mb-0">Delivery Point Details</label>
        <button type="button" class="btn btn-outline-primary btn-plus" id="addPodBtn">+</button>
    </div>

    <div id="podContainer" class="mt-2">
        {% for i in range(1,5) %}
        <div class="mt-2 pod-row" data-index="{{ i }}" {% if i>1 and (not form_data or not form_data["destination_" ~ i ~ "_city"]) %}style="display:none;"{% endif %}>
            <div class="box">
                <div class="box-title">Delivery Point {{ i }}</div>

                <label class="form-label">Factory / Warehouse address</label>
                <input name="destination_{{ i }}_address" class="form-control"
                       placeholder="Type factory/warehouse address..."
                       value="{{ form_data["destination_" ~ i ~ "_address"] if form_data and form_data["destination_" ~ i ~ "_address"] else '' }}">

                <label class="form-label mt-2">Port of Loading</label>
                <input name="destination_{{ i }}_port" class="form-control" list="locations"
                       placeholder="Start typing port of loading..."
                       value="{{ form_data["destination_" ~ i ~ "_port"] if form_data and form_data["destination_" ~ i ~ "_port"] else '' }}">

                <label class="form-label mt-2">City</label>
                <input name="destination_{{ i }}_city" class="form-control" list="locations"
                       {% if i==1 %}required{% endif %}
                       placeholder="Start typing city..."
                       value="{{ form_data["destination_" ~ i ~ "_city"] if form_data and form_data["destination_" ~ i ~ "_city"] else '' }}">

                <label class="form-label mt-2">Country</label>
                <input name="destination_{{ i }}_country" class="form-control" list="locations"
                       placeholder="Start typing country..."
                       value="{{ form_data["destination_" ~ i ~ "_country"] if form_data and form_data["destination_" ~ i ~ "_country"] else '' }}">
            </div>
        </div>
        {% endfor %}
        <div class="subtle-note">You can add up to 3 more Delivery Points.</div>
    </div>
</div>


                <!-- Transit Borders (all optional) -->
                <div class="col-lg-6">
                    <label class="form-label">Transit Country Border 1 (Optional)</label>
                    <input name="transit_border_1" class="form-control" placeholder="Type border name (optional)"
                           value="{{ form_data.transit_border_1 if form_data and form_data.transit_border_1 else '' }}">
                </div>

                <div class="col-lg-6">
                    <label class="form-label">Transit Country Border 2 (Optional)</label>
                    <input name="transit_border_2" class="form-control" placeholder="Type border name (optional)"
                           value="{{ form_data.transit_border_2 if form_data and form_data.transit_border_2 else '' }}">
                </div>

                <div class="col-lg-6">
                    <label class="form-label">Transit Country Border 3 (Optional)</label>
                    <input name="transit_border_3" class="form-control" placeholder="Type border name (optional)"
                           value="{{ form_data.transit_border_3 if form_data and form_data.transit_border_3 else '' }}">
                </div>

                <div class="col-lg-6">
                    <label class="form-label">Transit Country Border 4 (Optional)</label>
                    <input name="transit_border_4" class="form-control" placeholder="Type border name (optional)"
                           value="{{ form_data.transit_border_4 if form_data and form_data.transit_border_4 else '' }}">
                </div>

                <!-- Cargo + Packaging -->
                <div class="col-lg-6">
                    <label class="form-label">Cargo Type</label>
                    <input name="cargo_type" class="form-control" list="cargo_types" required placeholder="Select or type cargo type"
                           value="{{ form_data.cargo_type if form_data and form_data.cargo_type else '' }}">
                </div>
                <div class="col-lg-6">
                    <label class="form-label">Packaging Type</label>
                    <input name="packaging_type" class="form-control" list="packaging_types" required placeholder="Select or type packaging type"
                           value="{{ form_data.packaging_type if form_data and form_data.packaging_type else '' }}">
                </div>

<!-- Free days + Commodity + CBM + Cargo value -->
<div class="col-lg-3">
    <label class="form-label">Free Days to Return Container</label>
    <input name="free_days_return" type="number" step="1" min="0" required class="form-control"
           placeholder="Enter free days (integer)"
           value="{{ form_data.free_days_return if form_data and form_data.free_days_return else '' }}">
</div>

<div class="col-lg-3">
    <label class="form-label">Commodity</label>
    <input name="commodity" class="form-control" list="commodities" required placeholder="Select or type commodity"
           value="{{ form_data.commodity if form_data and form_data.commodity else '' }}">
</div>

<div class="col-lg-3">
    <label class="form-label">Cubic Meter (CBM) per Package</label>
    <input name="cbm" type="number" step="0.001" min="0"
           class="form-control" placeholder="e.g., 1.250"
           value="{{ form_data.cbm if form_data and form_data.cbm else '' }}">
</div>

<div class="col-lg-3">
    <label class="form-label">Cargo Value (Cost of Cargo)</label>
    <input name="cargo_value" id="cargo_value" type="number" step="0.01" min="0"
           class="form-control" placeholder="Enter cargo value (e.g., 1000)"
           value="{{ form_data.cargo_value if form_data and form_data.cargo_value else '' }}">
</div>


                <!-- Insurance + Misc + Weight -->
                <div class="col-lg-4">
                    <label class="form-label">Insurance Required?</label>
                    <input name="insurance_rate" id="insurance_rate" class="form-control" list="insurance_rates"
                           placeholder="Select or type % (e.g., 2.5%)"
                           value="{{ form_data.insurance_rate if form_data and form_data.insurance_rate else '' }}" disabled>
                    <div id="insurance_help" class="subtle-note">If you want insurance then please give the cargo value first.</div>
                    <div id="insurance_calc" class="subtle-note"></div>
                </div>

                <div class="col-lg-4">
                    <label class="form-label">Miscellaneous Cost (Optional)</label>
                    <input name="misc_cost" class="form-control" list="misc_costs"
                           placeholder="Select (e.g., 200$) or type integer (e.g., 275) — optional"
                           value="{{ form_data.misc_cost if form_data and form_data.misc_cost else '' }}">
                    <div class="subtle-note">You can leave this empty.</div>
                </div>

                <div class="col-lg-4">
                    <label class="form-label">Weight (tons)</label>
                    <select name="weight_choice" id="weight_choice" required class="form-select">
                        <option value="" selected disabled>Select weight range</option>
                        {% set w = form_data.weight_choice if form_data and form_data.weight_choice else "" %}
                        {% for opt in ["5-10 tons","10-15 tons","15-20 tons","20-25 tons","25-30 tons","Other"] %}
                        <option value="{{ opt }}" {% if w == opt %}selected{% endif %}>{{ opt }}</option>
                        {% endfor %}
                    </select>
                    <input type="number" step="0.01" min="0" name="weight_other" id="weight_other"
                           class="form-control mt-2" placeholder="Type weight in tons"
                           value="{{ form_data.weight_other if form_data and form_data.weight_other else '' }}"
                           style="display:none;">
                </div>

                <!-- Container Type / Size / Quantities -->
                <div class="col-lg-4">
                    <label class="form-label">Type of Container</label>
                    <input name="container_type" id="container_type" list="container_types" required class="form-control" placeholder="Select or type"
                           value="{{ form_data.container_type if form_data and form_data.container_type else '' }}">
                </div>

                <div class="col-lg-8">
                    <label class="form-label">Container Sizes &amp; Quantities</label>

                    <div class="row g-2 align-items-end">
                        <div class="col-md-4">
                            <div class="form-check">
                                {% set s20sel = form_data.size_20ft_selected if form_data and form_data.size_20ft_selected else "" %}
                                <input class="form-check-input" type="checkbox" id="size_20ft" name="size_20ft_selected" value="yes"
                                       {% if s20sel %}checked{% endif %}>
                                <label class="form-check-label" for="size_20ft">20ft</label>
                            </div>
                        </div>
                        <div class="col-md-8">
                            {% set s20cnt = form_data.size_20ft_count if form_data and form_data.size_20ft_count else "" %}
                            <input type="number" step="1" min="1"
                                   class="form-control"
                                   name="size_20ft_count"
                                   id="size_20ft_count"
                                   placeholder="How many 20ft containers?"
                                   value="{{ s20cnt }}">
                        </div>
                    </div>

                    <div class="row g-2 align-items-end mt-2">
                        <div class="col-md-4">
                            <div class="form-check">
                                {% set s40sel = form_data.size_40ft_selected if form_data and form_data.size_40ft_selected else "" %}
                                <input class="form-check-input" type="checkbox" id="size_40ft" name="size_40ft_selected" value="yes"
                                       {% if s40sel %}checked{% endif %}>
                                <label class="form-check-label" for="size_40ft">40ft</label>
                            </div>
                        </div>
                        <div class="col-md-8">
                            {% set s40cnt = form_data.size_40ft_count if form_data and form_data.size_40ft_count else "" %}
                            <input type="number" step="1" min="1"
                                   class="form-control"
                                   name="size_40ft_count"
                                   id="size_40ft_count"
                                   placeholder="How many 40ft containers?"
                                   value="{{ s40cnt }}">
                        </div>
                    </div>

                    <div class="subtle-note mt-1">
                        You can select one or both sizes. For each selected size, please enter the number of containers.
                    </div>
                </div>

                <!-- Dynamic: Dimensions -->
                <div class="col-12" id="dimensions_wrap" style="display:none;">
                    <div class="box">
                        <div class="box-title">Please provide Dimensions</div>
                        <div class="row g-3">
                            <div class="col-lg-6">
                                <label class="form-label">Width (ft)</label>
                                <input name="width_ft" id="width_ft" class="form-control" placeholder="Enter width in ft"
                                       value="{{ form_data.width_ft if form_data and form_data.width_ft else '' }}">
                            </div>
                            <div class="col-lg-6">
                                <label class="form-label">Height (ft)</label>
                                <input name="height_ft" id="height_ft" class="form-control" placeholder="Enter height in ft"
                                       value="{{ form_data.height_ft if form_data and form_data.height_ft else '' }}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dynamic: Temperature -->
                <div class="col-12" id="temp_wrap" style="display:none;">
                    <div class="box">
                        <div class="box-title">Temperature Required (°C)</div>
                        <div class="row g-3">
                            <div class="col-lg-6">
                                <label class="form-label">Temperature (Celsius)</label>
                                <input name="temperature_c" id="temperature_c" class="form-control" placeholder="Enter temperature in °C"
                                       value="{{ form_data.temperature_c if form_data and form_data.temperature_c else '' }}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Shipment type + lifting + offload -->
                <div class="col-lg-4">
                    <div class="box">
                        <div class="box-title">Shipment Type</div>
                        {% set st = form_data.shipment_type if form_data and form_data.shipment_type else "" %}
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="shipment_type" id="ship_commercial" value="Commercial"
                                   {% if st == "Commercial" %}checked{% endif %} required>
                            <label class="form-check-label" for="ship_commercial">Commercial</label>
                        </div>
                        <div class="form-check mt-1">
                            <input class="form-check-input" type="radio" name="shipment_type" id="ship_noncommercial" value="Non-Commercial"
                                   {% if st == "Non-Commercial" %}checked{% endif %} required>
                            <label class="form-check-label" for="ship_noncommercial">Non-Commercial</label>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="box">
                        <div class="box-title">Lifting / Labor required?</div>
                        {% set ll = form_data.lifting_labor_required if form_data and form_data.lifting_labor_required else "" %}
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="lifting_labor_required" id="lift_yes" value="Yes"
                                   {% if ll == "Yes" %}checked{% endif %} required>
                            <label class="form-check-label" for="lift_yes">Yes</label>
                        </div>
                        <div class="form-check mt-1">
                            <input class="form-check-input" type="radio" name="lifting_labor_required" id="lift_no" value="No"
                                   {% if ll == "No" %}checked{% endif %} required>
                            <label class="form-check-label" for="lift_no">No</label>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="box">
                        <div class="box-title">Who is responsible for offloading?</div>
                        {% set off = form_data.offloading_responsible if form_data and form_data.offloading_responsible else "" %}
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="offloading_responsible" id="offload_customer" value="Customer"
                                   {% if off == "Customer" %}checked{% endif %} required>
                            <label class="form-check-label" for="offload_customer">Customer</label>
                        </div>
                        <div class="form-check mt-1">
                            <input class="form-check-input" type="radio" name="offloading_responsible" id="offload_logenix" value="Logenix"
                                   {% if off == "Logenix" %}checked{% endif %} required>
                            <label class="form-check-label" for="offload_logenix">Logenix</label>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="box">
                        <div class="box-title">Who is responsible for Final Customs?</div>
                        {% set fc = form_data.final_customs_responsible if form_data and form_data.final_customs_responsible else "" %}
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="final_customs_responsible" id="customs_customer" value="Customer"
                                   {% if fc == "Customer" %}checked{% endif %} required>
                            <label class="form-check-label" for="customs_customer">Customer</label>
                        </div>
                        <div class="form-check mt-1">
                            <input class="form-check-input" type="radio" name="final_customs_responsible" id="customs_logenix" value="Logenix"
                                   {% if fc == "Logenix" %}checked{% endif %} required>
                            <label class="form-check-label" for="customs_logenix">Logenix</label>
                        </div>
                    </div>
                </div>

                <!-- Reloading -->
                <div class="col-lg-6">
                    <div class="box">
                        <div class="box-title">Reloading Required?</div>

                        {% set rr = form_data.reloading_required if form_data and form_data.reloading_required else "" %}
                        <div class="row g-2 align-items-end">
                            <div class="col-md-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="reloading_required" id="reload_yes" value="Yes"
                                           {% if rr == "Yes" %}checked{% endif %} required>
                                    <label class="form-check-label" for="reload_yes">Yes</label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="reloading_required" id="reload_no" value="No"
                                           {% if rr == "No" %}checked{% endif %} required>
                                    <label class="form-check-label" for="reload_no">No</label>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">How many reloadings are required? (1–5)</label>
                                <input name="reloading_count" id="reloading_count" type="number" step="1" min="1" max="5"
                                       class="form-control" placeholder="Enter integer 1 to 5"
                                       value="{{ form_data.reloading_count if form_data and form_data.reloading_count else '' }}" disabled>
                                <div id="reloading_help" class="subtle-note">Select "Yes" to unlock reloading details.</div>
                            </div>
                        </div>

                        <div class="mt-3" id="reloading_places_wrap" style="display:none;">
                            <div class="row g-3" id="reloading_places_container"></div>
                        </div>
                    </div>
                </div>

                <!-- Special cost -->
                <div class="col-12">
                    <div class="box">
                        <div class="box-title">Any Special Cost?</div>

                        {% set sc = form_data.special_cost_option if form_data and form_data.special_cost_option else "" %}
                        <div class="row g-2 align-items-end">
                            <div class="col-md-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="special_cost_option" id="special_yes" value="Yes"
                                           {% if sc == "Yes" %}checked{% endif %} required>
                                    <label class="form-check-label" for="special_yes">Yes</label>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="special_cost_option" id="special_no" value="No"
                                           {% if sc == "No" %}checked{% endif %} required>
                                    <label class="form-check-label" for="special_no">No</label>
                                </div>
                            </div>

                            <div class="col-md-4" id="special_reason_wrap" style="display:none;">
                                <label class="form-label">Reason (Tax, Trucking, etc.)</label>
                                <input name="reason" id="special_reason" class="form-control" placeholder="Type reason"
                                       value="{{ form_data.reason if form_data and form_data.reason else '' }}">
                            </div>

                            <div class="col-md-4" id="special_cost_wrap" style="display:none;">
                                <label class="form-label">Special Cost</label>
                                <input name="special_cost" id="special_cost" class="form-control" placeholder="e.g., 200$ or 19.5$"
                                       value="{{ form_data.special_cost if form_data and form_data.special_cost else '' }}">
                            </div>

                            <div class="col-md-12">
                                <div class="subtle-note" id="special_help">Select "Yes" to add reason and cost, otherwise choose "No".</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-end mt-4">
                    <button class="btn btn-primary btn-lg px-4" type="submit">Next</button>
                </div>
            </div>
            {% endif %}

            {% if stage == "routes" %}
                <!-- =========================
                     ROUTES STAGE
                     ========================= -->

                <input type="hidden" name="confirm_closed_route" id="confirm_closed_route" value="">

{% for i in range(1,5) %}
    <input type="hidden" name="shipping_from_{{ i }}_address" value="{{ form_data["shipping_from_" ~ i ~ "_address"] if form_data and form_data["shipping_from_" ~ i ~ "_address"] else '' }}">
    <input type="hidden" name="shipping_from_{{ i }}_port" value="{{ form_data["shipping_from_" ~ i ~ "_port"] if form_data and form_data["shipping_from_" ~ i ~ "_port"] else '' }}">
    <input type="hidden" name="shipping_from_{{ i }}_city" value="{{ form_data["shipping_from_" ~ i ~ "_city"] if form_data and form_data["shipping_from_" ~ i ~ "_city"] else '' }}">
    <input type="hidden" name="shipping_from_{{ i }}_country" value="{{ form_data["shipping_from_" ~ i ~ "_country"] if form_data and form_data["shipping_from_" ~ i ~ "_country"] else '' }}">

    <input type="hidden" name="destination_{{ i }}_address" value="{{ form_data["destination_" ~ i ~ "_address"] if form_data and form_data["destination_" ~ i ~ "_address"] else '' }}">
    <input type="hidden" name="destination_{{ i }}_port" value="{{ form_data["destination_" ~ i ~ "_port"] if form_data and form_data["destination_" ~ i ~ "_port"] else '' }}">
    <input type="hidden" name="destination_{{ i }}_city" value="{{ form_data["destination_" ~ i ~ "_city"] if form_data and form_data["destination_" ~ i ~ "_city"] else '' }}">
    <input type="hidden" name="destination_{{ i }}_country" value="{{ form_data["destination_" ~ i ~ "_country"] if form_data and form_data["destination_" ~ i ~ "_country"] else '' }}">
{% endfor %}


                <input type="hidden" name="company_name" value="{{ form_data.company_name if form_data and form_data.company_name else '' }}">
                <input type="hidden" name="salesperson_name" value="{{ form_data.salesperson_name if form_data and form_data.salesperson_name else '' }}">
                <input type="hidden" name="container_ownership" value="{{ form_data.container_ownership if form_data and form_data.container_ownership else '' }}">
                <input type="hidden" name="incoterm_origin" value="{{ form_data.incoterm_origin if form_data and form_data.incoterm_origin else '' }}">
                <input type="hidden" name="incoterm_destination" value="{{ form_data.incoterm_destination if form_data and form_data.incoterm_destination else '' }}">

                <input type="hidden" name="transit_border_1" value="{{ form_data.transit_border_1 if form_data and form_data.transit_border_1 else '' }}">
                <input type="hidden" name="transit_border_2" value="{{ form_data.transit_border_2 if form_data and form_data.transit_border_2 else '' }}">
                <input type="hidden" name="transit_border_3" value="{{ form_data.transit_border_3 if form_data and form_data.transit_border_3 else '' }}">
                <input type="hidden" name="transit_border_4" value="{{ form_data.transit_border_4 if form_data and form_data.transit_border_4 else '' }}">

                <input type="hidden" name="cargo_type" value="{{ form_data.cargo_type if form_data and form_data.cargo_type else '' }}">
                <input type="hidden" name="packaging_type" value="{{ form_data.packaging_type if form_data and form_data.packaging_type else '' }}">
                <input type="hidden" name="free_days_return" value="{{ form_data.free_days_return if form_data and form_data.free_days_return else '' }}">

                <input type="hidden" name="lifting_labor_required" value="{{ form_data.lifting_labor_required if form_data and form_data.lifting_labor_required else '' }}">
                <input type="hidden" name="offloading_responsible" value="{{ form_data.offloading_responsible if form_data and form_data.offloading_responsible else '' }}">
                <input type="hidden" name="final_customs_responsible" value="{{ form_data.final_customs_responsible if form_data and form_data.final_customs_responsible else '' }}">

                <input type="hidden" name="reloading_required" value="{{ form_data.reloading_required if form_data and form_data.reloading_required else '' }}">
                <input type="hidden" name="reloading_count" value="{{ form_data.reloading_count if form_data and form_data.reloading_count else '' }}">

                {% if form_data and form_data.reloading_places %}
                    {% for p in form_data.reloading_places %}
                        <input type="hidden" name="reloading_place_{{ loop.index }}" value="{{ p }}">
                    {% endfor %}
                {% endif %}

                <input type="hidden" name="commodity" value="{{ form_data.commodity if form_data and form_data.commodity else '' }}">
                <input type="hidden" name="commodity" value="{{ form_data.commodity if form_data and form_data.commodity else '' }}">
                <input type="hidden" name="weight_choice" value="{{ form_data.weight_choice if form_data and form_data.weight_choice else '' }}">
                <input type="hidden" name="weight_other" value="{{ form_data.weight_other if form_data and form_data.weight_other else '' }}">

                <input type="hidden" name="container_type" value="{{ form_data.container_type if form_data and form_data.container_type else '' }}">
                <input type="hidden" name="container_size" value="{{ form_data.container_size if form_data and form_data.container_size else '' }}">
                <input type="hidden" name="num_containers" value="{{ form_data.num_containers if form_data and form_data.num_containers else '' }}">
                <input type="hidden" name="size_20ft_selected" value="{{ form_data.size_20ft_selected if form_data and form_data.size_20ft_selected else '' }}">
                <input type="hidden" name="size_20ft_count" value="{{ form_data.size_20ft_count if form_data and form_data.size_20ft_count else '' }}">
                <input type="hidden" name="size_40ft_selected" value="{{ form_data.size_40ft_selected if form_data and form_data.size_40ft_selected else '' }}">
                <input type="hidden" name="size_40ft_count" value="{{ form_data.size_40ft_count if form_data and form_data.size_40ft_count else '' }}">

                <input type="hidden" name="width_ft" value="{{ form_data.width_ft if form_data and form_data.width_ft else '' }}">
                <input type="hidden" name="height_ft" value="{{ form_data.height_ft if form_data and form_data.height_ft else '' }}">
                <input type="hidden" name="temperature_c" value="{{ form_data.temperature_c if form_data and form_data.temperature_c else '' }}">

                <input type="hidden" name="cargo_value" value="{{ form_data.cargo_value if form_data and form_data.cargo_value else '' }}">
                <input type="hidden" name="insurance_rate" value="{{ form_data.insurance_rate if form_data and form_data.insurance_rate else '' }}">
                <input type="hidden" name="misc_cost" value="{{ form_data.misc_cost if form_data and form_data.misc_cost else '' }}">

                <input type="hidden" name="special_cost_option" value="{{ form_data.special_cost_option if form_data and form_data.special_cost_option else '' }}">
                <input type="hidden" name="reason" value="{{ form_data.reason if form_data and form_data.reason else '' }}">
                <input type="hidden" name="special_cost" value="{{ form_data.special_cost if form_data and form_data.special_cost else '' }}">

                <input type="hidden" name="shipment_type" value="{{ form_data.shipment_type if form_data and form_data.shipment_type else '' }}">

                <div class="route-select-card mt-2">
                    <div class="route-select-title">Choose a Route (Required)</div>

                    {% if route_error_msg %}
                        <div class="alert alert-warning mt-2 mb-2">{{ route_error_msg }}</div>
                    {% endif %}

                    {% if routes and routes|length > 0 %}
                        {% for r in routes %}
                        <div class="route-choice {% if r.id == best_route_id %}best{% endif %}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="route-name">
                                        <label class="form-check-label" for="route_{{ r.id }}">
                                            {{ r.title }}
                                            {% if r.id == best_route_id %}
                                                <span class="badge-best-route ms-2">Best Route</span>
                                            {% endif %}
                                        </label>
                                    </div>

                                    <div class="mt-2 d-flex flex-wrap gap-2">
                                        {% set rs = (r.route_status if r.route_status else "open")|lower %}
                                        {% if rs == "closed" %}
                                            <span class="badge-closed">closed</span>
                                        {% else %}
                                            <span class="badge-open">open</span>
                                        {% endif %}

                                        {% if r.transit_time_days and r.transit_time_days.min is not none and r.transit_time_days.max is not none %}
                                            <span class="badge-tt">Transit: {{ r.transit_time_days.min }}–{{ r.transit_time_days.max }} days</span>
                                        {% else %}
                                            <span class="badge-tt">Transit: N/A</span>
                                        {% endif %}

                                        {% if r.is_recent %}
                                            <span class="badge bg-secondary">Recent</span>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="d-flex align-items-center gap-2">
                                    <input class="form-check-input mt-0 route-radio"
                                           type="radio"
                                           name="selected_route_id"
                                           id="route_{{ r.id }}"
                                           value="{{ r.id }}"
                                           data-status="{{ (r.route_status if r.route_status else 'open')|lower }}"
                                           {% if selected_route_id == r.id %}checked{% endif %}
                                           required>
                                </div>
                            </div>

                            <div class="route-desc">{{ r.path }}</div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-warning mt-2">
                            No routes found for now.
                        </div>
                    {% endif %}

                    <div class="route-choice mt-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="route-name">
                                <label class="form-check-label" for="route_OWN">My own route</label>
                            </div>
                            <input class="form-check-input mt-0 route-radio" type="radio"
                                   name="selected_route_id"
                                   id="route_OWN"
                                   value="OWN"
                                   data-status="open"
                                   {% if selected_route_id == "OWN" %}checked{% endif %}
                                   required>
                        </div>

                        <div class="mt-2">
                            <textarea name="own_route_text" id="own_route_text" class="form-control"
                                      rows="3"
                                      placeholder="Type your route here (must include Pick Up Point and Point of Delivery)"></textarea>
                            <div class="subtle-note">
                                If you type your own route, it will be saved and shown again for the same Pick Up Point and Point of Delivery.
                            </div>
                        </div>
                    </div>

                    <div class="text-end mt-3">
                        <button class="btn btn-primary btn-lg px-4" type="submit">Generate</button>
                    </div>
                </div>
            {% endif %}
        </form>

        <!-- Submitted summary -->
        {% if submitted %}
            <hr class="my-4">
            <h5 class="fw-bold text-success">Query Submitted</h5>

            <div class="row g-3 mt-1">
                {% for item in submitted_items %}
                    <div class="col-lg-6">
                        <div class="box">
                            <div class="d-flex justify-content-between">
                                <div class="fw-bold">{{ item.label }}</div>
                                <div class="text-end">{{ item.value }}</div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <p class="text-muted mt-2"><em>Saved to queries.xlsx</em></p>
        {% endif %}

        <!-- Quotes -->
        {% if stage == "result" %}
            <hr class="my-4">

            <h5 class="fw-bold text-primary">Matching Quotes</h5>

            {% if error_msg %}
                <div class="alert alert-warning mt-3">{{ error_msg }}</div>
            {% endif %}

            {% if best_text %}
                <div class="alert alert-success mt-3 mb-2">
                    <strong>{{ best_text }}</strong>
                </div>
            {% endif %}

            {% if rates and rates|length > 0 %}
                <div class="row row-cols-1 row-cols-md-2 g-3 mt-2">
                    {% for r in rates %}
                    <div class="col">
                        <div class="p-3 rate-card h-100 {% if r.is_best %}best{% endif %}">
                            <div class="rate-header mb-2">
                                <div>{{ r.title }}</div>
                                <div class="d-flex gap-2 align-items-center">
                                    {% if r.validity_kind == "valid" %}
                                        <span class="badge-valid">{{ r.validity_label }}</span>
                                    {% elif r.validity_kind == "expired" %}
                                        <span class="badge-expired">{{ r.validity_label }}</span>
                                    {% else %}
                                        <span class="badge-unknown">{{ r.validity_label }}</span>
                                    {% endif %}
                                    {% if r.is_best %}
                                        <span class="badge-best">Best Option</span>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="kv">
                                {% for f in r.fields %}
                                <div class="rowline {% if f.is_grand_total %}gt-row{% endif %}">
                                    <div class="key">{{ f.key }}</div>
                                    <div class="val">
                                        {% if f.is_na and not f.is_grand_total %}
                                            <span class="na">N/A</span>
                                        {% else %}
                                            {{ f.val }}
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>

                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted mt-2">
                    No quotes found matching POL + POD + Commodity in <code>prices_updated.xlsx</code>.
                </p>
            {% endif %}
        {% endif %}

    </div>
</div>

<script>
    // ----------------------------
    // Helper parsing
    // ----------------------------
    function parseNumber(val) {
        if (!val) return null;
        const n = Number(val);
        return Number.isFinite(n) ? n : null;
    }
    function parsePercent(val) {
        if (!val) return null;
        const s = String(val).trim().toLowerCase();
        if (s === "none") return null;
        const cleaned = s.replace("%", "").trim();
        const n = Number(cleaned);
        return Number.isFinite(n) ? n : null;
    }
    function fmtMoney(n) {
        return "$" + n.toFixed(2);
    }

    // ----------------------------
    // POL / POD add buttons
    // ----------------------------
    const addPolBtn = document.getElementById("addPolBtn");
    const addPodBtn = document.getElementById("addPodBtn");
    const polRows = Array.from(document.querySelectorAll(".pol-row"));
    const podRows = Array.from(document.querySelectorAll(".pod-row"));

    function showNextRow(rows) {
        const hidden = rows.find(r => r.style.display === "none");
        if (hidden) hidden.style.display = "block";
    }

    if (addPolBtn) addPolBtn.addEventListener("click", () => showNextRow(polRows));
    if (addPodBtn) addPodBtn.addEventListener("click", () => showNextRow(podRows));

    // ----------------------------
    // Weight dropdown behavior
    // ----------------------------
    const weightChoice = document.getElementById("weight_choice");
    const weightOther  = document.getElementById("weight_other");

    function syncWeightOther() {
        if (!weightChoice || !weightOther) return;
        if (weightChoice.value === "Other") {
            weightOther.style.display = "block";
            weightOther.required = true;
        } else {
            weightOther.style.display = "none";
            weightOther.required = false;
            weightOther.value = "";
        }
    }
    if (weightChoice) weightChoice.addEventListener("change", syncWeightOther);
    syncWeightOther();

    // ----------------------------
    // Cargo value -> enable/disable insurance + realtime calc
    // ----------------------------
    const cargoValue = document.getElementById("cargo_value");
    const insuranceRate = document.getElementById("insurance_rate");
    const insuranceHelp = document.getElementById("insurance_help");
    const insuranceCalc = document.getElementById("insurance_calc");

    function syncInsuranceLockAndCalc() {
        if (!cargoValue || !insuranceRate) return;

        const cv = parseNumber(cargoValue.value);
        if (cv === null || cv <= 0) {
            insuranceRate.disabled = true;
            insuranceRate.value = insuranceRate.value || "";
            if (insuranceHelp) insuranceHelp.style.display = "block";
            if (insuranceCalc) insuranceCalc.textContent = "";
            return;
        }

        insuranceRate.disabled = false;
        if (insuranceHelp) insuranceHelp.style.display = "none";

        const pct = parsePercent(insuranceRate.value);
        if (pct === null) {
            if (insuranceCalc) insuranceCalc.textContent = "";
            return;
        }

        const amount = (pct / 100.0) * cv;
        if (insuranceCalc) insuranceCalc.innerHTML = "<strong>Calculated Insurance Amount:</strong> " + fmtMoney(amount);
    }

    if (cargoValue) cargoValue.addEventListener("input", syncInsuranceLockAndCalc);
    if (insuranceRate) insuranceRate.addEventListener("input", syncInsuranceLockAndCalc);
    syncInsuranceLockAndCalc();

    // ----------------------------
    // Reloading logic
    // ----------------------------
    const reloadYes = document.getElementById("reload_yes");
    const reloadNo = document.getElementById("reload_no");
    const reloadingCount = document.getElementById("reloading_count");
    const reloadingHelp = document.getElementById("reloading_help");
    const placesWrap = document.getElementById("reloading_places_wrap");
    const placesContainer = document.getElementById("reloading_places_container");

    function clearPlaces() {
        if (!placesContainer || !placesWrap) return;
        placesContainer.innerHTML = "";
        placesWrap.style.display = "none";
    }

    function buildPlacesInputs(count) {
        clearPlaces();
        if (!count || count < 1) return;

        placesWrap.style.display = "block";
        for (let i = 1; i <= count; i++) {
            const col = document.createElement("div");
            col.className = "col-lg-6";
            col.innerHTML = `
                <label class="form-label">Enter the Place/Port/Border name where reloading will be done (${i})</label>
                <input name="reloading_place_${i}" class="form-control" placeholder="Type place/port/border name" required>
            `;
            placesContainer.appendChild(col);
        }
    }

    function syncReloadingUI() {
        if (!reloadYes || !reloadingCount || !reloadingHelp) return;

        const yesSelected = reloadYes.checked;
        if (!yesSelected) {
            reloadingCount.disabled = true;
            reloadingCount.value = "";
            reloadingHelp.style.display = "block";
            clearPlaces();
            return;
        }

        reloadingCount.disabled = false;
        reloadingHelp.style.display = "none";

        let c = parseInt(reloadingCount.value || "0", 10);
        if (!Number.isFinite(c)) c = 0;
        if (c < 1) { clearPlaces(); return; }
        if (c > 5) { c = 5; reloadingCount.value = "5"; }

        buildPlacesInputs(c);
    }

    if (reloadYes) reloadYes.addEventListener("change", syncReloadingUI);
    if (reloadNo) reloadNo.addEventListener("change", syncReloadingUI);
    if (reloadingCount) reloadingCount.addEventListener("input", syncReloadingUI);
    syncReloadingUI();

    // ----------------------------
    // Special cost show/hide
    // ----------------------------
    const specialYes = document.getElementById("special_yes");
    const specialNo = document.getElementById("special_no");
    const specialReasonWrap = document.getElementById("special_reason_wrap");
    const specialCostWrap = document.getElementById("special_cost_wrap");
    const specialReason = document.getElementById("special_reason");
    const specialCost = document.getElementById("special_cost");

    function syncSpecialCostUI() {
        if (!specialYes || !specialReasonWrap || !specialCostWrap) return;

        const yesSelected = specialYes.checked;

        if (!yesSelected) {
            specialReasonWrap.style.display = "none";
            specialCostWrap.style.display = "none";
            if (specialReason) { specialReason.required = false; }
            if (specialCost) { specialCost.required = false; }
            return;
        }

        specialReasonWrap.style.display = "block";
        specialCostWrap.style.display = "block";
        if (specialReason) specialReason.required = true;
        if (specialCost) specialCost.required = true;
    }

    if (specialYes) specialYes.addEventListener("change", syncSpecialCostUI);
    if (specialNo) specialNo.addEventListener("change", syncSpecialCostUI);
    syncSpecialCostUI();

    // ----------------------------
    // Container type -> show dimensions/temp
    // ----------------------------
    const containerTypeEl = document.getElementById("container_type");
    const dimWrap = document.getElementById("dimensions_wrap");
    const tempWrap = document.getElementById("temp_wrap");
    const widthEl = document.getElementById("width_ft");
    const heightEl = document.getElementById("height_ft");
    const tempEl = document.getElementById("temperature_c");

    function syncContainerSpecialFields() {
        const v = (containerTypeEl ? containerTypeEl.value : "").toLowerCase();
        const isOpenOrFlat = v.includes("open top") || v.includes("flat rack");
        const isReefer = v.includes("reefer");

        if (dimWrap) dimWrap.style.display = isOpenOrFlat ? "block" : "none";
        if (tempWrap) tempWrap.style.display = isReefer ? "block" : "none";

        if (widthEl) widthEl.required = isOpenOrFlat;
        if (heightEl) heightEl.required = isOpenOrFlat;

        if (!isOpenOrFlat) {
            if (widthEl) widthEl.value = widthEl.value || "";
            if (heightEl) heightEl.value = heightEl.value || "";
        }

        if (tempEl) tempEl.required = isReefer;
        if (!isReefer && tempEl) {
            tempEl.value = tempEl.value || "";
        }
    }

    if (containerTypeEl) containerTypeEl.addEventListener("input", syncContainerSpecialFields);
    syncContainerSpecialFields();

    // ----------------------------
    // Container sizes & counts (20ft / 40ft)
    // ----------------------------
    const size20Cb = document.getElementById("size_20ft");
    const size40Cb = document.getElementById("size_40ft");
    const size20CountEl = document.getElementById("size_20ft_count");
    const size40CountEl = document.getElementById("size_40ft_count");

    function syncSizeCounts() {
        if (!size20Cb || !size20CountEl || !size40Cb || !size40CountEl) return;

        if (size20Cb.checked) {
            size20CountEl.disabled = false;
            size20CountEl.required = true;
        } else {
            size20CountEl.disabled = true;
            size20CountEl.required = false;
            size20CountEl.value = "";
        }

        if (size40Cb.checked) {
            size40CountEl.disabled = false;
            size40CountEl.required = true;
        } else {
            size40CountEl.disabled = true;
            size40CountEl.required = false;
            size40CountEl.value = "";
        }
    }

    if (size20Cb) size20Cb.addEventListener("change", syncSizeCounts);
    if (size40Cb) size40Cb.addEventListener("change", syncSizeCounts);
    syncSizeCounts();

    // ----------------------------
    // CLOSED ROUTE CONFIRMATION & basic size validation
    // ----------------------------
    const quoteForm = document.getElementById("quoteForm");
    const confirmClosedInput = document.getElementById("confirm_closed_route");

    function getSelectedRouteRadio() {
        const radios = Array.from(document.querySelectorAll('input[name="selected_route_id"]'));
        return radios.find(r => r.checked) || null;
    }

    // Validate container sizes on "Next"
    if (quoteForm) {
        quoteForm.addEventListener("submit", function (e) {
            const actionEl = document.querySelector('input[name="_action"]');
            const actionVal = actionEl ? (actionEl.value || "").toLowerCase() : "";

            if (actionVal === "next") {
                if (size20Cb || size40Cb) {
                    const anySelected = (size20Cb && size20Cb.checked) || (size40Cb && size40Cb.checked);
                    if (!anySelected) {
                        e.preventDefault();
                        alert("Please select at least one container size (20ft or 40ft) and enter the quantity.");
                        return;
                    }
                }
            }
        });
    }

    // Closed route confirmation on "Generate"
    if (quoteForm) {
        quoteForm.addEventListener("submit", function (e) {
            const actionEl = document.querySelector('input[name="_action"]');
            const actionVal = actionEl ? (actionEl.value || "").toLowerCase() : "";

            if (actionVal !== "generate") return;
            if (!confirmClosedInput) return;

            const selected = getSelectedRouteRadio();
            if (!selected) return;

            const status = (selected.dataset.status || "open").toLowerCase();
            if (status !== "closed") {
                confirmClosedInput.value = "";
                return;
            }

            if ((confirmClosedInput.value || "").toLowerCase() === "yes") return;

            const ok = window.confirm("Your selected route is CLOSED. Are you sure you want to go with the selected closed route?");
            if (!ok) {
                e.preventDefault();
                return;
            }
            confirmClosedInput.value = "yes";
        });
    }
</script>

</body>
</html>